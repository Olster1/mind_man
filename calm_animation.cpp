                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            internal void InitAnimation(animation *Animation, game_memory *Memory,  char **FileNames, u32 FileNameCount, r32 DirectionValue, char *Name, memory_arena *Arena) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            //Animation->Qualities[POSE] = PoseValue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Animation->Qualities[DIRECTION] = DirectionValue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Animation->Name = Name;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for(u32 i = 0; i < FileNameCount; ++i) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                bitmap *Bitmap = Animation->Frames + Animation->FrameCount++; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                *Bitmap = LoadImage(Memory, Arena, FileNames[i], V2(0.5f, 0.2f));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        static quality_info QualityInfo[ANIMATE_QUALITY_COUNT] = {{2*PI32, true}};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        internal animation *FindAnimation(animation *Animations, u32 AnimationsCount, char *Name) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            animation *Result = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            forN(AnimationsCount) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                animation *Anim = Animations + AnimationsCountIndex;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if(DoStringsMatch(Anim->Name, Name)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Result = Anim;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    break;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return Result;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        internal animation *GetAnimation(animation *Animations, u32 AnimationsCount,  r32 *Qualities,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         r32 *Weights) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            animation *BestResult = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            r32 BestValue = 100000.0f;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            forN(AnimationsCount) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                animation *Anim = Animations + AnimationsCountIndex;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                r32 ThisValue = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for(u32 i = 0; i < ANIMATE_QUALITY_COUNT; ++i) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    r32 Value = Qualities[i];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    r32 TestValue = Anim->Qualities[i];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    quality_info Info= QualityInfo[i];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    r32 DifferenceSqr = Sqr(TestValue - Value);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if(Info.IsPeriodic) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if(DifferenceSqr > Sqr(Info.MaxValue/2)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            r32 Min = TestValue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            r32 Max = Value;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if(Max < Min) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Min = Value;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Max = TestValue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Min += Info.MaxValue/2;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            DifferenceSqr = Sqr(Max - Min);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ThisValue += Weights[i]*DifferenceSqr;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if(ThisValue < BestValue) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    BestResult = Anim;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    BestValue = ThisValue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Assert(BestResult);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return BestResult;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        internal void AddAnimationToList(game_state *GameState, memory_arena *Arena, entity *Ent, animation *Animation, r32 Period = 0.08f) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            animation_list_item *Item = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if(GameState->AnimationItemFreeList) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Item = GameState->AnimationItemFreeList;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                GameState->AnimationItemFreeList = GameState->AnimationItemFreeList->Next;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Item = PushStruct(Arena, animation_list_item);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Assert(Item);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Item->Timer = {};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Item->Timer.Period = Period;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Item->FrameIndex = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Item->Animation = Animation;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            //Add animation to end of list;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Item->Next = &Ent->AnimationListSentintel;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Item->Prev = Ent->AnimationListSentintel.Prev;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Ent->AnimationListSentintel.Prev->Next = Item;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Ent->AnimationListSentintel.Prev = Item;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        internal void UpdateAnimation(game_state *State, entity *Ent, r32 dt, animation *NextAnimation) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            animation_list_item *Item = Ent->AnimationListSentintel.Next;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Assert(Item != &Ent->AnimationListSentintel);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if(UpdateTimer(&Item->Timer, dt)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Item->FrameIndex++;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                //if(Item->FrameIndex >= Item->Animation->FrameCount) 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if(NextAnimation != Item->Animation || Item->FrameIndex >= Item->Animation->FrameCount)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                { 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    //finished animation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Item->FrameIndex = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if(NextAnimation) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        //Remove from linked list
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Ent->AnimationListSentintel.Next = Item->Next;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Item->Next->Prev = &Ent->AnimationListSentintel;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        //Add to free list
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Item->Next = State->AnimationItemFreeList;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        State->AnimationItemFreeList = Item;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        //Add new animation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        AddAnimationToList(State, &State->MemoryArena, Ent, NextAnimation);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        inline b32 IsEmpty(animation_list_item *Sentinel) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            b32 Result = Sentinel->Next == Sentinel;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return Result;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        inline bitmap *GetBitmap(animation_list_item *Item) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Assert(Item->FrameIndex < Item->Animation->FrameCount);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bitmap *Result = &Item->Animation->Frames[Item->FrameIndex];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return Result;
}